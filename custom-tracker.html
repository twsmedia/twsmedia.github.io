<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Custom Season Tracker (Fixed UTC Offset)</title>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; line-height: 1.5; font-size: 18px; margin: 0; }
    h2 { margin: 0 0 8px; }
    .note { color:#555; margin-bottom: 12px; font-size: 14px; }
    .row { display:flex; flex-wrap: wrap; gap: 12px; align-items: center; margin: 10px 0; }
    label { font-size: 16px; }
    input[type="text"], input[type="datetime-local"], button { font-size: 16px; padding: 6px 8px; }
    #seasonProgress { margin: 10px 0; }
    #seasonTimes { margin: 8px 0 14px; }
    #milestones { font-size: 16px; margin-bottom: 16px; }
    .divider { height: 1px; background: #e4e4e4; margin: 18px 0; }
    .preset-section { background: #f0f8ff; padding: 12px; border-radius: 4px; margin: 10px 0; }
    .preset-buttons { display: flex; gap: 8px; margin: 8px 0; flex-wrap: wrap; }
    .preset-btn { background: #4CAF50; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; }
    .preset-btn:hover { background: #45a049; }
    .save-preset { background: #2196F3; }
    .save-preset:hover { background: #1976D2; }
    .delete-preset { background: #f44336; }
    .delete-preset:hover { background: #d32f2f; }
    input[type="text"].preset-name { width: 200px; }
  </style>
</head>
<body>
  <h2>Custom Season Tracker</h2>
  <div id="tzNote" class="note"></div>

  <!-- Preset Section -->
  <div class="preset-section">
    <strong>🔖 Saved Presets:</strong>
    <div id="presetButtons" class="preset-buttons"></div>
    <div class="row" style="margin-top: 12px;">
      <input type="text" id="presetName" class="preset-name" placeholder="Enter preset name (e.g., 'Fall Reading')">
      <button id="savePresetBtn" class="preset-btn save-preset">Save Current Settings as Preset</button>
    </div>
    <div class="note">Save your current settings as a preset, then use the buttons above to quickly switch between different trackers.</div>
  </div>

  <!-- Settings -->
  <div class="row">
    <label for="seasonName">Label (optional):</label>
    <input id="seasonName" type="text" placeholder="e.g., 'Fall Reading Challenge'">
  </div>

  <div class="row">
    <label for="startDT">Start:</label>
    <input id="startDT" type="datetime-local" />
    <label for="endDT">End:</label>
    <input id="endDT" type="datetime-local" />
  </div>

  <div class="row">
    <label for="utcOffset">Custom UTC offset (no DST):</label>
    <input id="utcOffset" type="text" placeholder="Examples: 0, -5.5, +05:30">
    <button id="applyBtn">Apply / Save</button>
    <span id="offsetStatus" class="note"></span>
  </div>

  <div class="divider"></div>

  <!-- Output -->
  <div id="seasonHeading"></div>
  <div id="seasonProgress"></div>
  <div id="seasonTimes" class="note"></div>
  <div id="milestones"></div>
  <div id="currentTime" class="note"></div>

  <script>
    (function () {
      const { DateTime, FixedOffsetZone } = luxon;

      function $(id){ return document.getElementById(id); }

      // --- Utilities for fixed offset handling (no DST) ---
      function minutesToSignedHHMM(mins){
        const sign = mins < 0 ? "-" : "+";
        const a = Math.abs(mins);
        const hh = String(Math.floor(a/60)).padStart(2,"0");
        const mm = String(a % 60).padStart(2,"0");
        return sign + hh + ":" + mm;
      }
      function zonePrettyLabel(mins){
        if (mins == null) return "UTC";
        const a = Math.abs(mins), sign = mins < 0 ? "-" : "+";
        const hh = Math.floor(a/60), mm = a % 60;
        return mm === 0 ? `UTC${sign}${hh}` : `UTC${minutesToSignedHHMM(mins)}`;
      }
      function parseOffsetToMinutes(s){
        if (!s) return null;
        s = s.trim();
        if (/^[+-]?\d+(\.\d+)?$/.test(s)) return Math.round(parseFloat(s)*60);
        const m = s.match(/^([+-])(\d{1,2}):([0-5]\d)$/);
        if (m){
          const sign = m[1] === "-" ? -1 : 1;
          const hh = parseInt(m[2],10), mm = parseInt(m[3],10);
          return sign*(hh*60+mm);
        }
        return null;
      }

      // --- Storage keys ---
      const LS = {
        NAME: "customSeason_name",
        START: "customSeason_start",
        END: "customSeason_end",
        OFFSET: "customSeason_offset",
        PRESETS: "customSeason_presets"
      };

      // --- Preset management ---
      function getPresets() {
        const saved = localStorage.getItem(LS.PRESETS);
        return saved ? JSON.parse(saved) : {};
      }

      function savePresets(presets) {
        localStorage.setItem(LS.PRESETS, JSON.stringify(presets));
      }

      function saveCurrentAsPreset(name) {
        if (!name.trim()) {
          alert("Please enter a name for the preset.");
          return;
        }
        
        const presets = getPresets();
        presets[name] = {
          name: nameInput.value.trim(),
          start: startInput.value,
          end: endInput.value,
          offset: offsetInput.value.trim()
        };
        
        savePresets(presets);
        renderPresetButtons();
        $("presetName").value = "";
      }

      function loadPreset(presetName) {
        const presets = getPresets();
        const preset = presets[presetName];
        if (!preset) return;
        
        nameInput.value = preset.name || "";
        startInput.value = preset.start || "";
        endInput.value = preset.end || "";
        offsetInput.value = preset.offset || "";
        
        // Also apply the settings
        applySettings();
      }

      function deletePreset(presetName) {
        if (!confirm(`Delete preset "${presetName}"?`)) return;
        
        const presets = getPresets();
        delete presets[presetName];
        savePresets(presets);
        renderPresetButtons();
      }

      function renderPresetButtons() {
        const container = $("presetButtons");
        const presets = getPresets();
        
        container.innerHTML = "";
        
        if (Object.keys(presets).length === 0) {
          container.innerHTML = '<div class="note">No saved presets yet. Save your first preset below!</div>';
          return;
        }
        
        for (const [name, preset] of Object.entries(presets)) {
          const btn = document.createElement("button");
          btn.className = "preset-btn";
          btn.textContent = name;
          btn.onclick = () => loadPreset(name);
          container.appendChild(btn);
          
          const deleteBtn = document.createElement("button");
          deleteBtn.className = "preset-btn delete-preset";
          deleteBtn.textContent = "×";
          deleteBtn.title = `Delete "${name}"`;
          deleteBtn.onclick = (e) => {
            e.stopPropagation();
            deletePreset(name);
          };
          container.appendChild(deleteBtn);
        }
      }

      // --- Milestones ---
      const milestones = [
        { label: "10%", value: 0.10 },
        { label: "20%", value: 0.20 },
        { label: "25%", value: 0.25 },
        { label: "30%", value: 0.30 },
        { label: "⅓",  value: 1/3   },
        { label: "40%", value: 0.40 },
        { label: "50%", value: 0.50 },
        { label: "60%", value: 0.60 },
        { label: "⅔",  value: 2/3   },
        { label: "70%", value: 0.70 },
        { label: "75%", value: 0.75 },
        { label: "80%", value: 0.80 },
        { label: "90%", value: 0.90 }
      ];

      // --- Elements ---
      const nameInput = $("seasonName");
      const startInput = $("startDT");
      const endInput = $("endDT");
      const offsetInput = $("utcOffset");
      const applyBtn = $("applyBtn");
      const presetNameInput = $("presetName");
      const savePresetBtn = $("savePresetBtn");

      // --- Load values from localStorage ---
      function loadFromLocalStorage(){
        const name = localStorage.getItem(LS.NAME) || "";
        const startV = localStorage.getItem(LS.START) || "";
        const endV = localStorage.getItem(LS.END) || "";
        const off = localStorage.getItem(LS.OFFSET) || "";
        nameInput.value = name;
        startInput.value = startV;
        endInput.value = endV;
        offsetInput.value = off;
      }

      // --- Zone helpers ---
      function getUserFixedZone(){
        const saved = localStorage.getItem(LS.OFFSET);
        const mins = parseOffsetToMinutes(saved);
        if (mins === null) return { zone: FixedOffsetZone.utcInstance, mins: 0, label: "UTC" };
        return { zone: FixedOffsetZone.instance(mins), mins, label: zonePrettyLabel(mins) };
      }
      function setOffsetStatus(){
        const saved = localStorage.getItem(LS.OFFSET);
        const mins = parseOffsetToMinutes(saved);
        $("offsetStatus").textContent = mins === null
          ? " (Times show in UTC by default; enter an offset to change.)"
          : " (" + zonePrettyLabel(mins) + ")";
      }

      // --- Parse datetime-local input into Luxon DT in the chosen fixed zone ---
      function parseLocalInputToZoneDT(value, zone){
        if (!value) return null;
        const m = value.match(/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2})(?::(\d{2}))?$/);
        if (!m) return null;
        const [ , Y, Mo, D, H, Mi, S ] = m;
        return DateTime.fromObject(
          {
            year: +Y, month: +Mo, day: +D,
            hour: +H, minute: +Mi, second: S ? +S : 0, millisecond: 0
          },
          { zone }
        );
      }

      // --- Apply settings (save to localStorage and render) ---
      function applySettings() {
        const val = offsetInput.value.trim();
        const mins = parseOffsetToMinutes(val);
        if (val !== "" && mins === null) {
          alert("Please enter a valid UTC offset (e.g., 0, 1, -5.5, +05:30), or leave blank for UTC.");
          return;
        }
        
        // Save to localStorage
        localStorage.setItem(LS.NAME, nameInput.value.trim());
        localStorage.setItem(LS.START, startInput.value);
        localStorage.setItem(LS.END, endInput.value);
        localStorage.setItem(LS.OFFSET, val);
        
        setOffsetStatus();
        render();

        if (!timer){
          timer = setInterval(render, 1000);
        }
      }

      // --- Rendering ---
      let timer = null;

      function render(){
        const { zone, label } = getUserFixedZone();
        $("tzNote").textContent = `This tracker uses a fixed offset: ${label} (ignores DST).`;

        const nm = nameInput.value.trim();
        const startDT = parseLocalInputToZoneDT(startInput.value, zone);
        const endDT   = parseLocalInputToZoneDT(endInput.value, zone);

        const headingName = nm ? nm : "Custom Season";
        $("seasonHeading").innerHTML = `<strong>${headingName}</strong>`;

        if (!startDT || !endDT){
          $("seasonProgress").textContent = "Enter a valid start and end date-time, then press Apply / Save.";
          $("seasonTimes").textContent = "";
          $("milestones").innerHTML = "";
          $("currentTime").textContent = "";
          return;
        }
        if (endDT <= startDT){
          $("seasonProgress").textContent = "End must be after Start.";
          $("seasonTimes").textContent = "";
          $("milestones").innerHTML = "";
          $("currentTime").textContent = "";
          return;
        }

        const now = DateTime.now().setZone(zone);
        const totalSeconds = endDT.diff(startDT).as("seconds");
        const elapsedSeconds = now.diff(startDT).as("seconds");
        const clampedElapsed = Math.max(0, Math.min(totalSeconds, elapsedSeconds));
        const pct = Math.max(0, Math.min(100, (clampedElapsed/totalSeconds)*100));

        let progressText = "";
        if (now < startDT){
          progressText = "This season hasn't started yet.";
        } else if (now >= endDT){
          progressText = "This season has ended (100.00% complete).";
        } else if (pct >= 99.99 && pct < 100){
          progressText = "This season is greater than 99.99% complete.";
        } else {
          progressText = `This season is ${pct.toFixed(2)}% complete.`;
        }
        $("seasonProgress").textContent = progressText;

        const fmt = "EEE, MMM d, yyyy, HH:mm:ss";
        $("seasonTimes").innerHTML =
          `Start: <strong>${startDT.toFormat(fmt)} ${label}</strong><br>` +
          `End: <strong>${endDT.toFormat(fmt)} ${label}</strong>`;

        let html = `<h3>Milestone Dates (${label}):</h3>`;
        html += `<p><strong>${Math.floor(clampedElapsed).toLocaleString()}</strong> seconds have passed out of <strong>${Math.floor(totalSeconds).toLocaleString()}</strong>.</p><ul>`;
        for (const m of milestones){
          const dt = startDT.plus({ seconds: totalSeconds * m.value });
          html += `<li>${m.label} complete: <strong>${dt.toFormat(fmt)} ${label}</strong></li>`;
        }
        html += `</ul>`;
        $("milestones").innerHTML = html;

        $("currentTime").textContent = `⏱ Current time: ${now.toFormat(fmt)} (${label})`;

        if (now >= endDT && timer){
          clearInterval(timer);
          timer = null;
        }
      }

      // --- Event handlers ---
      applyBtn.addEventListener("click", applySettings);

      savePresetBtn.addEventListener("click", () => {
        saveCurrentAsPreset(presetNameInput.value.trim());
      });

      presetNameInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          saveCurrentAsPreset(presetNameInput.value.trim());
        }
      });

      // --- Init ---
      loadFromLocalStorage();
      setOffsetStatus();
      renderPresetButtons();
      render();
      timer = setInterval(render, 1000);
    })();
  </script>
</body>
</html>